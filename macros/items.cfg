#textdomain wesnoth-To_Lands_Unknown

#define TLU_PICKUPPABLE_ITEM ID X Y CAN_TAKE_FILTER_WML IMAGE IMAGE2 TEXT TAKE_IT_STRING LEAVE_IT_STRING CANNOT_TAKE_TEXT OBJECT_WML
    [item]
        x,y={X},{Y}
        image={IMAGE}
    [/item]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            x,y={X},{Y}
            side=1
        [/filter]

        [if]
            [have_unit]
                x,y={X},{Y}
                {CAN_TAKE_FILTER_WML}
                side=1
            [/have_unit]

            [variable]
                name=item_{ID}_picked_up
                not_equals=yes
            [/variable]

            [then]
                [message]
                    speaker=narrator
                    message={TEXT}
                    image={IMAGE2}

                    [option]
                        message={TAKE_IT_STRING}

                        [command]
                            {OBJECT_WML}

                            [remove_item]
                                x,y={X},{Y}
                                image={IMAGE}
                            [/remove_item]

                            [set_variable]
                                name=item_{ID}_picked_up
                                value=yes
                            [/set_variable]
                            [set_variable]
                                name=item_{ID}_in_use
                                value=yes
                            [/set_variable]
                        [/command]
                    [/option]
                    [option]
                        message={TAKE_IT_STRING}+ _ " for later use (on recruit/recall of a unit)"

                        [command]
                            [remove_item]
                                x,y={X},{Y}
                            [/remove_item]

                            [set_variable]
                                name=item_{ID}_picked_up
                                value=yes
                            [/set_variable]
                            [set_variable]
                                name=item_{ID}_in_use
                                value=no
                            [/set_variable]
                        [/command]
                    [/option]

                    [option]
                        message={LEAVE_IT_STRING}

                        [command]
                            [allow_undo]
                            [/allow_undo]
                        [/command]
                    [/option]
                [/message]
            [/then]

            [else]
                [if]
                    [have_unit]
                        {CAN_TAKE_FILTER_WML}
                        side=1
                    [/have_unit]
                    [then]
                        [if]
                            [variable]
                                name=item_{ID}_picked_up
                                not_equals=yes
                            [/variable]

                            [then]
                                [message]
                                    speaker=narrator
                                    message={CANNOT_TAKE_TEXT}+" "+_"You can still take the item for later use, though."
                                    image={IMAGE}
                                    for_side=$side_number
                                    # the above is used to prevent an AI side from
                                    # accidentally triggering this dialog
                                    [option]
                                        message={TAKE_IT_STRING}+" "+"for later use (on recruit/recall of a unit)"

                                        [command]
                                            [remove_item]
                                                x,y={X},{Y}
                                            [/remove_item]

                                            [set_variable]
                                                name=item_{ID}_picked_up
                                                value=yes
                                            [/set_variable]
                                            [set_variable]
                                                name=item_{ID}_in_use
                                                value=no
                                            [/set_variable]
                                        [/command]
                                    [/option]

                                    [option]
                                        message={LEAVE_IT_STRING}

                                        [command]
                                            [allow_undo]
                                            [/allow_undo]
                                        [/command]
                                    [/option]
                                [/message]
                            [/then]
                        [/if]
                    [/then]
                    [else]
                        #if player doesn't have a unit at the moment
                        [message]
                            speaker=narrator
                            message= _ "At the moment you do not have a unit in your army who could use this artifact. However the item will be picked up, so it can wait for a suitable unit to be recruited or recalled."
                            image={IMAGE}
                            for_side=$side_number
                        [/message]

                        [remove_item]
                            x,y={X},{Y}
                        [/remove_item]

                        [set_variable]
                            name=item_{ID}_picked_up
                            value=yes
                        [/set_variable]
                        [set_variable]
                            name=item_{ID}_in_use
                            value=no
                        [/set_variable]
                    [/else]
                [/if]

                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]
#enddef

#this is a slightly modified version of the default macro - the only difference is the IMAGE2 parameter, which displays a separate image in the main pickup message
#define TLU_PICKUPPABLE_ITEM2 ID X Y CAN_TAKE_FILTER_WML IMAGE IMAGE2 TEXT TAKE_IT_STRING LEAVE_IT_STRING CANNOT_TAKE_TEXT OBJECT_WML

    [item]
        x,y={X},{Y}
        image={IMAGE}
    [/item]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            x,y={X},{Y}
        [/filter]

        [if]
            [have_unit]
                x,y={X},{Y}
                {CAN_TAKE_FILTER_WML}
            [/have_unit]

            [variable]
                name=item_{ID}_picked_up
                not_equals=yes
            [/variable]

            [then]
                [message]
                    speaker=narrator
                    message={TEXT}
                    image={IMAGE2}

                    [option]
                        label={TAKE_IT_STRING}

                        [command]
                            {OBJECT_WML}

                            [remove_item]
                                x,y={X},{Y}
                                image={IMAGE}
                            [/remove_item]

                            [set_variable]
                                name=item_{ID}_picked_up
                                value=yes
                            [/set_variable]
                        [/command]
                    [/option]

                    [option]
                        label={LEAVE_IT_STRING}

                        [command]
                            [allow_undo]
                            [/allow_undo]
                        [/command]
                    [/option]
                [/message]
            [/then]

            [else]
                [if]
                    [variable]
                        name=item_{ID}_picked_up
                        not_equals=yes
                    [/variable]

                    [then]
                        [message]
                            speaker=narrator
                            message={CANNOT_TAKE_TEXT}
                            image={IMAGE}
                            side_for=$side_number
                            # the above is used to prevent an AI side from
                            # accidentally triggering this dialog
                        [/message]
                    [/then]
                [/if]

                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

    [event]
        name=victory

        [clear_variable]
            name=item_{ID}_picked_up
        [/clear_variable]
    [/event]
#enddef

#define TLU_MEHIR_PORTRAIT_ELEMENTS
~BLIT($portrait_cap,0,0)~BLIT($portrait_armor,0,0)~BLIT($portrait_sunglasses,0,0)
#enddef

#define TLU_PORTRAIT_ITEMS_FIX TYPE PORTRAIT
    [if]
        [have_unit]
            id=Mehir
            type={TYPE}
        [/have_unit]
        [then]
            {MODIFY_UNIT id=Mehir profile "portraits/{PORTRAIT}.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"}
        [/then]
    [/if]
#enddef

#define ITEM_APPLIER
    [event]
        name=recruit,recall
        first_time_only=no

        [filter]
            side=1
        [/filter]

        {VARIABLE gave_item no}

        [if]
            [variable]
                name=item_GCarpet_in_use
                equals=no
            [/variable]
            [and]
                [variable]
                    name=item_GCarpet_picked_up
                    equals=yes
                [/variable]
            [/and]
            [then]
                [if]
                    [have_unit]
                        type=EoMa_Carpet_Rider,EoMa_Carpet_Master
                        x,y=$x1,$y1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message={DESCR_CARPET}
                            image=misc/artifact-carpet.png

                            [option]
                                message= _ "carpet^Take it"

                                [command]
                                    [object]
                                        name= _ "Golden Carpet"
                                        image=items/carpet.png
                                        duration=forever
                                        description= _ "Woven of golden threads, inspired by Abyssal winds. Everyone who possesses this ancient vehicle gains amazing speed and agility.
Speed increases by 50%"
                                        [effect]
                                            apply_to=movement
                                            increase=50%
                                        [/effect]
                                        [effect]
                                            apply_to=overlay
                                            add="misc/blank-hex.png~BLIT(misc/artifact-icon-carpet.png,$unit.variables.artifact_count,0)"
                                        [/effect]
                                        [then]
                                            {ADVANCE_UNIT x,y=$x1,$y1 ""}
                                        [/then]
                                    [/object]
                                    [store_unit]
                                        [filter]
                                            id=$unit.id
                                        [/filter]
                                        variable=unit
                                    [/store_unit]
                                    [set_variables]
                                        name=unit.modifications.trait
                                        mode=append

                                        [value]
                                            id=gcarpet
                                            name= _ "golden carpet"
                                            description= _ "This unit flies on the ancient Golden Carpet.

Effects:
Speed increases by 50%"
                                        [/value]
                                    [/set_variables]
                                    {VARIABLE_OP unit.variables.artifact_count add 10}
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]
                                    [set_variable]
                                        name=item_GCarpet_picked_up
                                        value=yes
                                    [/set_variable]
                                    [set_variable]
                                        name=item_GCarpet_in_use
                                        value=yes
                                    [/set_variable]
                                    {VARIABLE gave_item yes}
                                [/command]
                            [/option]

                            [option]
                                message= _ "carpet^Leave it for another unit"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]

        [if]
            [variable]
                name=item_DCloak_in_use
                equals=no
            [/variable]
            [and]
                [variable]
                    name=item_DCloak_picked_up
                    equals=yes
                [/variable]
            [/and]
            [then]
                [if]
                    [have_unit]
                        type=EoMa_Camel_Rider,EoMa_Heavy_Camel_Rider,EoMa_Camel_Master
                        x,y=$x1,$y1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message={DESCR_CLOAK}
                            image=misc/artifact-cloak.png

                            [option]
                                message= _ "cloak^Take it"

                                [command]
                                    [object]
                                        name= _ "Desert Cloak"
                                        image=items/cloak.png
                                        duration=forever
                                        description= _ "Marked with mysterious symbols, this cloak was enchanted a long time ago, but it still grants its owner good protection against fire.
Advances the unit (unless the unit is already at maximum level)
Grants 50% fire resistance"
                                        [effect]
                                            apply_to=resistance
                                            replace=true
                                            [resistance]
                                                fire=50
                                            [/resistance]
                                        [/effect]
                                        [effect]
                                            apply_to=overlay
                                            add="misc/blank-hex.png~BLIT(misc/artifact-icon-cloak.png,$unit.variables.artifact_count,0)"
                                        [/effect]
                                        [then]
                                            {ADVANCE_UNIT x,y=$x1,$y1 ()}
                                        [/then]
                                    [/object]
                                    [store_unit]
                                        [filter]
                                            id=$unit.id
                                        [/filter]
                                        variable=unit
                                    [/store_unit]
                                    [set_variables]
                                        name=unit.modifications.trait
                                        mode=append

                                        [value]
                                            id=dcloak
                                            name= _ "desert cloak"
                                            description= _ "This unit wears the famous Desert Cloak of ancients.

Effects:
Grants 50% fire resistance"
                                        [/value]
                                    [/set_variables]
                                    {VARIABLE_OP unit.variables.artifact_count add 10}
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]
                                    [set_variable]
                                        name=item_DCloak_picked_up
                                        value=yes
                                    [/set_variable]
                                    [set_variable]
                                        name=item_DCloak_in_use
                                        value=yes
                                    [/set_variable]
                                    {VARIABLE gave_item yes}
                                [/command]
                            [/option]

                            [option]
                                message= _ "cloak^Leave it for another unit"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]

        [if]
            [variable]
                name=item_Spear_in_use
                equals=no
            [/variable]
            [and]
                [variable]
                    name=item_Spear_picked_up
                    equals=yes
                [/variable]
            [/and]
            [then]
                [if]
                    [have_unit]
                        type=EoMa_Rhami,EoMa_RhamiKai
                        x,y=$x1,$y1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message={DESCR_SPEAR}
                            image=misc/artifact-spear.png

                            [option]
                                message= _ "spear^Take it"

                                [command]
                                    [object]
                                        name= _ "Spear of Rhami"
                                        image=items/spear-rhami.png
                                        duration=forever
                                        description= _ "This weapon, forged from the light of the Abyss, is a part of the equipment used by magical entities called Rhami’kai. The Ancestors stole one of those spears and enhanced it magically.
Advances the unit (unless the unit is already at maximum level)
Increases the attack by 25%
Increases magical resistances by 10%"
                                        [effect]
                                            apply_to=attack
                                            name=trident
                                            increase_damage=25%
                                        [/effect]
                                        [effect]
                                            apply_to=attack
                                            name=trident2
                                            increase_damage=25%
                                        [/effect]
                                        [effect]
                                            apply_to=resistance
                                            [resistance]
                                                arcane=-10
                                                fire=-10
                                                cold=-10
                                            [/resistance]
                                        [/effect]
                                        [effect]
                                            apply_to=overlay
                                            add="misc/blank-hex.png~BLIT(misc/artifact-icon-spear.png,$unit.variables.artifact_count,0)"
                                        [/effect]
                                    [/object]
                                    [if]
                                        [have_unit]
                                            x,y=$x1,$y1
                                            type=EoMa_Rhami
                                        [/have_unit]
                                        [then]
                                            {ADVANCE_UNIT x,y=$x1,$y1 "EoMa_RhamiKai"}
                                        [/then]
                                        [elseif]
                                            [have_unit]
                                                x,y=$x1,$y1
                                                type=EoMa_RhamiKai
                                            [/have_unit]
                                            [then]
                                                {ADVANCE_UNIT x,y=$x1,$y1 "EoMa_HoRhami"}
                                            [/then]
                                        [/elseif]
                                        [else]
                                        [/else]
                                    [/if]
                                    [store_unit]
                                        [filter]
                                            id=$unit.id
                                        [/filter]
                                        variable=unit
                                    [/store_unit]
                                    [set_variables]
                                        name=unit.modifications.trait
                                        mode=append

                                        [value]
                                            id=spearrhami
                                            name= _ "spear of rhami"
                                            description= _ "This unit is holding a powerful spear of abysmal origin.

Effects:
Increases the attack by 25%
Increases magic resistance by 10%"
                                        [/value]
                                    [/set_variables]
                                    {VARIABLE_OP unit.variables.artifact_count add 10}
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]
                                    [set_variable]
                                        name=item_Spear_picked_up
                                        value=yes
                                    [/set_variable]
                                    [set_variable]
                                        name=item_Spear_in_use
                                        value=yes
                                    [/set_variable]
                                    {VARIABLE gave_item yes}
                                [/command]
                            [/option]

                            [option]
                                message= _ "spear^Leave it for another unit"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]

        [if]
            [variable]
                name=item_Collar_in_use
                equals=no
            [/variable]
            [and]
                [variable]
                    name=item_Collar_picked_up
                    equals=yes
                [/variable]
            [/and]
            [then]
                [if]
                    [have_unit]
                        race=eoma_magical
                        x,y=$x1,$y1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message={DESCR_COLLAR}
                            image=misc/artifact-collar.png

                            [option]
                                message= _ "collar^Take it"

                                [command]
                                    [object]
                                        name= _ "Collar of Recall"
                                        image=items/collar.png
                                        duration=forever
                                        description= _ "A legendary artifact, a masterpiece made by the Ancestors. In olden times a magical collar was made, which when placed upon a magical being, could recall it after death.
The unit is recalled back to the leader
After each recall the unit is fully healed
The unit can be recalled only 3 times. After that it dies for sure."
                                        [effect]
                                            apply_to=overlay
                                            add="misc/blank-hex.png~BLIT(misc/artifact-icon-collar.png,$unit.variables.artifact_count,0)"
                                        [/effect]
                                        [effect]
                                            apply_to=new_animation
                                            [animation]
                                                apply_to=flash

                                                [frame]
                                                    duration=400
                                                [/frame]
                                                [flash_frame]
                                                    duration=400
                                                    image="projectiles/secrethit.png"
                                                    alpha=1.0~0.0:400
                                                    y=-3
                                                    layer=99
                                                [/flash_frame]
                                            [/animation]
                                        [/effect]
                                    [/object]
                                    [set_variables]
                                        name=unit.modifications.trait
                                        mode=append

                                        [value]
                                            id=collar
                                            name= _ "collar"
                                            description= _ "After death the unit is recalled back to leader. Activates only 3 times."
                                        [/value]
                                    [/set_variables]
                                    {VARIABLE unit.status.collar yes}
                                    {VARIABLE unit.status.firstrecall yes}
                                    {VARIABLE unit.status.secondrecall yes}
                                    {VARIABLE unit.status.thirdrecall yes}
                                    {VARIABLE_OP unit.variables.artifact_count add 10}
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]

                                    [set_variable]
                                        name=item_Collar_picked_up
                                        value=yes
                                    [/set_variable]
                                    [set_variable]
                                        name=item_Collar_in_use
                                        value=yes
                                    [/set_variable]
                                    {VARIABLE gave_item yes}
                                [/command]
                            [/option]

                            [option]
                                message= _ "collar^Leave it for another unit"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]

        [if]
            [variable]
                name=item_Amulet_Elem_in_use
                equals=no
            [/variable]
            [and]
                [variable]
                    name=item_Amulet_Elem_picked_up
                    equals=yes
                [/variable]
            [/and]
            [then]
                [if]
                    [have_unit]
                        type=EoMa_Water_Elemental,EoMa_Fire_Elemental,EoMa_Air_Elemental,EoMa_Earth_Elemental,EoMa_Water_Avatar,EoMa_Fire_Avatar,EoMa_Air_Avatar,EoMa_Earth_Avatar,EoMa_Water_God,EoMa_Fire_God,EoMa_Air_God,EoMa_Earth_God
                        x,y=$x1,$y1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message={DESCR_AMULET}
                            image=misc/artifact-amulet.png

                            [option]
                                message= _ "amulet^Take it"

                                [command]
                                    [object]
                                        name= _ "Amulet of Metamorph"
                                        image=items/necklace.png
                                        duration=forever
                                        description= _ "The Ancestors were fascinated with elementals — entities made of pure energy. They also dreamed about creating a creature from a mix of all four known elements. Unfortunately they failed. Yet at the end an unique amulet was created, capable of transforming one element into another one. This is one of the most powerful relics made by the Ancestors.
The elemental unit can turn into other elemental
(use right-click on the unit to activate)"
                                        [effect]
                                            apply_to=new_ability
                                            [abilities]
                                                {ABILITY_AMULET_METAMORPH}
                                            [/abilities]
                                        [/effect]
                                        [effect]
                                            apply_to=overlay
                                            add="misc/blank-hex.png~BLIT(misc/artifact-icon-amulet.png,$unit.variables.artifact_count,0)"
                                        [/effect]
                                        [then]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=modified
                                            [/store_unit]
                                            {VARIABLE modified.status.amulet_elem yes}
                                            [set_variables]
                                                name=unit.modifications.trait
                                                mode=append

                                                [value]
                                                    id=metamorph
                                                    name= _ "metamorph"
                                                    description= _ "This elemental wears the Amulet of Metamorph.

Effects:
The elemental unit can turn into another elemental (use right-click on the unit to activate).
The unit becomes loyal."
                                                [/value]
                                            [/set_variables]
                                            {VARIABLE_OP unit.variables.artifact_count add 10}
                                            [unstore_unit]
                                                variable=modified
                                                find_vacant=no
                                            [/unstore_unit]
                                            {CLEAR_VARIABLE modified}
                                            {METAMORPH_ALL}
                                        [/then]
                                    [/object]

                                    [store_unit]
                                        [filter]
                                            id=$unit.id
                                        [/filter]
                                        variable=unit
                                    [/store_unit]
                                    {VARIABLE_OP unit.variables.artifact_count add 10}
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]
                                    {MAKE_LOYAL_NORMAL $unit.id}

                                    [set_variable]
                                        name=item_Amulet_Elem_picked_up
                                        value=yes
                                    [/set_variable]
                                    [set_variable]
                                        name=item_Amulet_Elem_in_use
                                        value=yes
                                    [/set_variable]
                                    {VARIABLE gave_item yes}
                                [/command]
                            [/option]

                            [option]
                                message= _ "amulet^Leave it for another unit"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_Cuirass_in_use
                equals=no
            [/variable]
            [and]
                [variable]
                    name=item_Cuirass_picked_up
                    equals=yes
                [/variable]
            [/and]
            [then]
                [if]
                    [have_unit]
                        race=eoma_summoner
                        x,y=$x1,$y1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message={DESCR_ARMOR}
                            image=misc/artifact-armor.png

                            [option]
                                message= _ "armor^Take it"

                                [command]
                                    [object]
                                        name= _ "Cuirass of the Ancients"
                                        image=items/armor.png
                                        duration=forever
                                        description= _ "Richly decorated plates, solid workmanship and magical symbols: this must be the legendary armor of Ka-Gattans.

- Increases physical resistances by 25%
- Increases fire and cold resistances by 20%
- Decreases arcane resistance by 15%"
                                        [effect]
                                            apply_to=resistance
                                            [resistance]
                                                blade=-25
                                                pierce=-25
                                                impact=-25
                                                fire=-20
                                                cold=-20
                                                arcane=15
                                            [/resistance]
                                        [/effect]
                                        [effect]
                                            apply_to=overlay
                                            add="misc/blank-hex.png~BLIT(misc/artifact-icon-armor.png,$unit.variables.artifact_count,0)"
                                        [/effect]
                                    [/object]

                                    [store_unit]
                                        [filter]
                                            id=$unit.id
                                        [/filter]
                                        variable=unit
                                    [/store_unit]
                                    {VARIABLE_OP unit.variables.artifact_count add 10}
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]

                                    [set_variable]
                                        name=item_Cuirass_picked_up
                                        value=yes
                                    [/set_variable]
                                    [set_variable]
                                        name=item_Cuirass_in_use
                                        value=yes
                                    [/set_variable]
                                    {VARIABLE gave_item yes}
                                [/command]
                            [/option]

                            [option]
                                message= _ "armor^Leave it for another unit"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_Staff_in_use
                equals=no
            [/variable]
            [and]
                [variable]
                    name=item_Staff_picked_up
                    equals=yes
                [/variable]
            [/and]
            [then]
                [if]
                    [have_unit]
                        type=EoMa_Novice_Summoner,EoMa_Dispeller,EoMa_Banisher
                        x,y=$x1,$y1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message={DESCR_STAFF}
                            image=misc/artifact-staff.png

                            [option]
                                message= _ "staff^Take it"

                                [command]
                                    [object]
                                        name= _ "Banishment Staff"
                                        image=items/staff.png
                                        duration=forever
                                        description= _ "- Advances the unit (unless the unit is already at maximum level)
- the banishment attack never misses
- the staff/frozen gate attacks deal +2 damage 
- increases magical resistances by 10%"
                                        [effect]
                                            apply_to=attack
                                            name=banishment
                                            [set_specials]
                                                mode=append
                                                {WEAPON_SPECIAL_EOMA_ALWAYSHITS}
                                            [/set_specials]
                                        [/effect]
                                        [effect]
                                            apply_to=attack
                                            name=staff
                                            set_icon=attacks/staff-magic.png
                                            increase_damage=2
                                        [/effect]
                                        [effect]
                                            apply_to=attack
                                            name=frozen gate
                                            increase_damage=2
                                        [/effect]
                                        [effect]
                                            apply_to=overlay
                                            add="misc/blank-hex.png~BLIT(misc/artifact-icon-staff.png,$unit.variables.artifact_count,0)"
                                        [/effect]
                                    [/object]
                                    [if]
                                        [have_unit]
                                            x,y=$x1,$y1
                                            type=EoMa_Novice_Summoner
                                        [/have_unit]
                                        [then]
                                            {ADVANCE_UNIT x,y=$x1,$y1 "EoMa_Dispeller"}
                                        [/then]
                                        [else]
                                            [if]
                                                [have_unit]
                                                    x,y=$x1,$y1
                                                    type=EoMa_Dispeller
                                                [/have_unit]
                                                [then]
                                                    {ADVANCE_UNIT x,y=$x1,$y1 ()}
                                                [/then]
                                            [/if]
                                        [/else]
                                    [/if]
                                    [store_unit]
                                        [filter]
                                            id=$unit.id
                                        [/filter]
                                        variable=unit
                                    [/store_unit]
                                    [set_variables]
                                        name=unit.modifications.trait
                                        mode=append

                                        [value]
                                            id=staffbanisher
                                            name= _ "banishment staff"
                                            description= _ "This unit is holding a powerful staff which once belonging to the first Master of Banishers.

Effects:
- the banishment attack never misses
- the staff/frozen gate attacks deal +2 damage 
- increases magical resistances by 10%"
                                        [/value]
                                    [/set_variables]
                                    {VARIABLE_OP unit.variables.artifact_count add 10}
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]

                                    [set_variable]
                                        name=item_Staff_picked_up
                                        value=yes
                                    [/set_variable]
                                    [set_variable]
                                        name=item_Staff_in_use
                                        value=yes
                                    [/set_variable]
                                    {VARIABLE gave_item yes}
                                [/command]
                            [/option]

                            [option]
                                message= _ "staff^Leave it for another unit"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_regenring_in_use
                equals=no
            [/variable]
            [and]
                [variable]
                    name=item_regenring_picked_up
                    equals=yes
                [/variable]
            [/and]
            [then]
                [if]
                    [have_unit]
                        race=eoma_summoner
                        x,y=$x1,$y1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message={DESCR_RING}
                            image=misc/artifact-ring.png

                            [option]
                                message= _ "ring^Take it"

                                [command]
                                    [object]
                                        name= _ "Ring of Regeneration"
                                        image=items/ring-red.png
                                        duration=forever
                                        description= _ "This mysterius ring is richly decorated with magical symbols making it somehow connected to the Abyss. The bearer of this relic may benefit from strange energies flowing into his body, healing him effectively.
- Grants regeneration"
                                        [effect]
                                            apply_to=new_ability
                                            [abilities]
                                                {ABILITY_EOMA_REGENERATES}
                                            [/abilities]
                                        [/effect]
                                        [effect]
                                            apply_to=overlay
                                            add="misc/blank-hex.png~BLIT(misc/artifact-icon-regenring.png,$unit.variables.artifact_count,0)"
                                        [/effect]
                                    [/object]
                                    [store_unit]
                                        [filter]
                                            id=$unit.id
                                        [/filter]
                                        variable=unit
                                    [/store_unit]
                                    [set_variables]
                                        name=unit.modifications.trait
                                        mode=append

                                        [value]
                                            id=regenring
                                            name= _ "ring of regeneration"
                                            description= _ "This unit wears the Ring of Regeneration.

Effects:
Grants regeneration"
                                        [/value]
                                    [/set_variables]
                                    {VARIABLE_OP unit.variables.artifact_count add 10}
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]
                                    [set_variable]
                                        name=item_regenring_picked_up
                                        value=yes
                                    [/set_variable]
                                    [set_variable]
                                        name=item_regenring_in_use
                                        value=yes
                                    [/set_variable]
                                    {VARIABLE gave_item yes}
                                [/command]
                            [/option]

                            [option]
                                message= _ "ring^Leave it for another unit"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_Cap_in_use
                equals=no
            [/variable]
            [and]
                [variable]
                    name=item_Cap_picked_up
                    equals=yes
                [/variable]
            [/and]
            [then]
                [if]
                    [have_unit]
                        type=EoMa_Novice_Summoner,EoMa_Summoner,EoMa_Grand_Summoner,EoMa_Summons_Master,TLU_Mehir_Commander,EoMa_Heavy_Summoner,EoMa_Neutral_Summoner
                        x,y=$x1,$y1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message={DESCR_CAP}
                            image=misc/artifact-cap.png

                            [option]
                                message= _ "cap^Take it"

                                [command]
                                    [object]
                                        name= _ "Cap of Power"
                                        image=items/cap.png
                                        duration=forever
                                        description= _ "Increases magical power by 20%
Decreases experience points needed for advancement by 25%"
                                        [effect]
                                            apply_to=attack
                                            name=scroll
                                            increase_damage=20%
                                        [/effect]
                                        [effect]
                                            apply_to=attack
                                            name=magic arrow
                                            increase_damage=20%
                                        [/effect]
                                        [effect]
                                            apply_to=attack
                                            name=circle of destruction
                                            increase_damage=20%
                                        [/effect]
                                        [effect]
                                            apply_to=attack
                                            name=ema
                                            increase_damage=20%
                                        [/effect]
                                        [effect]
                                            apply_to=attack
                                            name=circlebalance
                                            increase_damage=20%
                                        [/effect]
                                        [effect]
                                            apply_to=attack
                                            name=incantation of power
                                            increase_damage=20%
                                        [/effect]
                                        [effect]
                                            apply_to=max_experience
                                            increase=-25%
                                        [/effect]
                                        [effect]
                                            apply_to=overlay
                                            add="misc/blank-hex.png~BLIT(misc/artifact-icon-cap.png,$unit.variables.artifact_count,0)"
                                        [/effect]
                                    [/object]
                                    [store_unit]
                                        [filter]
                                            id=$unit.id
                                        [/filter]
                                        variable=unit
                                    [/store_unit]
                                    [set_variables]
                                        name=unit.modifications.trait
                                        mode=append

                                        [value]
                                            id=capofpower
                                            name= _ "cap of power"
                                            description= _ "This unit wears a magical cap, which enhances its magical power.

Effects:
Increases magical power by 20%
Decreases experience points needed for advancement by 25%"
                                        [/value]
                                    [/set_variables]
                                    {VARIABLE_OP unit.variables.artifact_count add 10}
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]
                                    [set_variable]
                                        name=item_Cap_picked_up
                                        value=yes
                                    [/set_variable]
                                    [set_variable]
                                        name=item_Cap_in_use
                                        value=yes
                                    [/set_variable]
                                    {VARIABLE gave_item yes}
                                [/command]
                            [/option]

                            [option]
                                message= _ "cap^Leave it for another unit"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_Sphere_in_use
                equals=no
            [/variable]
            [and]
                [variable]
                    name=item_Sphere_picked_up
                    equals=yes
                [/variable]
            [/and]
            [then]
                [if]
                    [have_unit]
                        x,y=$x1,$y1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=narrator
                            message={DESCR_SPHERE}
                            image=misc/artifact-orb.png

                            [option]
                                message= _ "sphere^Take it"

                                [command]
                                    [object]
                                        name= _ "Reficul's sphere"
                                        image=items/ball-magenta.png
                                        duration=forever
                                        description= _ "Increases magical and physical resistances by 15%"
                                        [effect]
                                            apply_to=halo
                                            halo=halo/elven/elven-shield-halo-[60,80,100,80,60]pct.png~GS()~BLEND(255,64,0,0.75)~SCALE(220,220):[200*2,450,200*2]
                                        [/effect]
                                        [effect]
                                            apply_to=resistance
                                            replace=false
                                            [resistance]
                                                arcane=-15
                                                blade=-15
                                                fire=-15
                                                cold=-15
                                                pierce=-15
                                                impact=-15
                                            [/resistance]
                                        [/effect]
                                        [effect]
                                            apply_to=overlay
                                            add="misc/blank-hex.png~BLIT(misc/artifact-icon-sphere.png,$unit.variables.artifact_count,0)"
                                        [/effect]
                                    [/object]
                                    [store_unit]
                                        [filter]
                                            id=$unit.id
                                        [/filter]
                                        variable=unit
                                    [/store_unit]
                                    [set_variables]
                                        name=unit.modifications.trait
                                        mode=append
                                        [value]
                                            id=sphereofreficul
                                            name= _ "reficul's sphere"
                                            description= _ "This unit wears a sphere once belonging to Reficul.

Effects:
Resitances to physical and magical attacks are increased by 15%"
                                        [/value]
                                    [/set_variables]
                                    {VARIABLE_OP unit.variables.artifact_count add 10}
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]
                                    [set_variable]
                                        name=item_Sphere_picked_up
                                        value=yes
                                    [/set_variable]
                                    [set_variable]
                                        name=item_Sphere_in_use
                                        value=yes
                                    [/set_variable]
                                    {VARIABLE gave_item yes}
                                [/command]
                            [/option]

                            [option]
                                message= _ "sphere^Leave it for another unit"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]
        #allow undo if the whole action does nothing
        {IF_VAR gave_item equals yes (
            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        )}
        {CLEAR_VARIABLE gave_item}
    [/event]

    [event]
        name=portraits
        first_time_only=no

        #set variables if they are not set
        [if]
            [have_unit]
                id=Mehir
                trait=capofpower
            [/have_unit]
            [then]
                {VARIABLE portrait_cap misc/portrait-cap.png}
            [/then]
            [else]
                {VARIABLE portrait_cap misc/blank-hex.png}
            [/else]
        [/if]
        [if]
            [have_unit]
                id=Mehir
                trait=cota
            [/have_unit]
            [then]
                [if]
                    [have_unit]
                        type=TLU_Mehir_Commander
                    [/have_unit]
                    [then]
                        {VARIABLE portrait_armor misc/portrait-armor-commander.png}
                    [/then]
                    [elseif]
                        [have_unit]
                            type=TLU_Mehir_Leader
                        [/have_unit]
                        [then]
                            {VARIABLE portrait_armor misc/portrait-armor-leader.png}
                        [/then]
                    [/elseif]
                    [else]
                        {VARIABLE portrait_armor misc/portrait-armor-last.png}
                    [/else]
                [/if]
            [/then]
            [else]
                {VARIABLE portrait_armor misc/blank-hex.png}
            [/else]
        [/if]

        #equip items on the default portrait by adding ~BLITs
        {TLU_PORTRAIT_ITEMS_FIX TLU_Mehir_Commander mehir-commander}
        {TLU_PORTRAIT_ITEMS_FIX TLU_Mehir_Leader mehir-leader}
        {TLU_PORTRAIT_ITEMS_FIX TLU_The_Last_Summoner mehir-last}
    [/event]

    [event]
        name=prestart

        [fire_event]
            name=portraits
        [/fire_event]
    [/event]
#enddef
